require('dotenv').config();
const {OpenAI} = require("openai");

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  organization: process.env.OPENAI_ORG_ID
})


const ADMIN_EMAILS = (process.env.MAIL_TO || '')
  .split(',')
  .map(email => email.trim())
  .filter(Boolean);

function buildIdeasPrompt2(data) {
  const location = data.location || '–Ω–µ —É–∫–∞–∑–∞–Ω';
  const ownInvestment = data.ownInvestment || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
  const additionalInfo = data.additionalInfo || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';

  return `–ó–∞–∫–∞–∑—á–∏–∫ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª 3 –ø—Ä–æ—Å—Ç—ã–µ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏, —É—á–∏—Ç—ã–≤–∞—è –µ–≥–æ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–≥–∏–æ–Ω, –±—é–¥–∂–µ—Ç, –ø–æ–∂–µ–ª–∞–Ω–∏—è). –ò–¥–µ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã —á–µ–ª–æ–≤–µ–∫—É –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π.

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: –í —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏¬ª –ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏
 
---

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: 

# –ò–¥–µ—è ‚Ññ1 [–ù–∞–∑–≤–∞–Ω–∏–µ] 
   [–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏] 
##   1.1. –¶–µ–ª–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: 
##   1.2. –†—ã–Ω–æ–∫ —Å–±—ã—Ç–∞: 
##   1.3. –ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: 
 	- –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞ 1: X —Ä—É–±. 
 	- –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞ 2: Y —Ä—É–±. 
 	- –ò—Ç–æ–≥–æ: Z —Ä—É–±. 
##   1.3. –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–ª—å–∑–∞: 

*(–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∏–¥–µ–π 2 –∏ 3)*

---

–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—á–∏–∫–∞: 
- –†–µ–≥–∏–æ–Ω –∏–ª–∏ –≥–æ—Ä–æ–¥: ${location}
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞: ${ownInvestment} 
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${additionalInfo}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:  
- 3 –∏–¥–µ–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ñ–µ—Ä. 
- –Ø–∑—ã–∫: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–æ–≤.`;
}

function buildIdeasPrompt(data) {
  const location = data.location || '–Ω–µ —É–∫–∞–∑–∞–Ω';
  const ownInvestment = data.ownInvestment || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';
  const additionalInfo = data.additionalInfo || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ';

  return `–ó–∞–∫–∞–∑—á–∏–∫ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª 3 –ø—Ä–æ—Å—Ç—ã–µ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏, —É—á–∏—Ç—ã–≤–∞—è –µ–≥–æ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–≥–∏–æ–Ω, –±—é–¥–∂–µ—Ç, –ø–æ–∂–µ–ª–∞–Ω–∏—è). –ò–¥–µ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã —á–µ–ª–æ–≤–µ–∫—É –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π.

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: 
1. –í —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏¬ª –ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏. 
2. ¬´–°—É–º–º–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è¬ª –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–≤–Ω–∞: 
   - –ü—Ä–∏–≤–ª–µ–∫–∞–µ–º—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ —Å–æ—Ü–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É = (–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π ‚àí —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞). 
   - –ï—Å–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –±–æ–ª—å—à–µ, —á–µ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è, —É–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —á–∞—Å—Ç—å. 
3. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ —Å–æ—Ü–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É ‚Äî 350 000 —Ä—É–±. (—Å–ª–µ–¥–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å!).

---

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: 

# –ò–¥–µ—è ‚Ññ1 [–ù–∞–∑–≤–∞–Ω–∏–µ] 
   [–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏] 
##   1.1. –¶–µ–ª–µ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: 
##   1.2. –†—ã–Ω–æ–∫ —Å–±—ã—Ç–∞: 
##   1.3. –ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: 
 	- –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞ 1: X —Ä—É–±. 
 	- –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–∞ 2: Y —Ä—É–±. 
 	- –ò—Ç–æ–≥–æ: Z —Ä—É–±. 
###   1.3.1. –°—É–º–º–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è: 
 	- –°–æ—Ü–∫–æ–Ω—Ç—Ä–∞–∫—Ç: (Z ‚àí —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞) —Ä—É–±. 
 	- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞: [—É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑—á–∏–∫–∞ –∏–ª–∏ –µ—ë —á–∞—Å—Ç—å]. 
##   1.4. –°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–ª—å–∑–∞: 

*(–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∏–¥–µ–π 2 –∏ 3)*

---

–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—á–∏–∫–∞: 
- –†–µ–≥–∏–æ–Ω –∏–ª–∏ –≥–æ—Ä–æ–¥: ${location}
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞: ${ownInvestment} 
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${additionalInfo}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:  
- 3 –∏–¥–µ–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ñ–µ—Ä. 
- –Ø–∑—ã–∫: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–æ–≤.`;
}
function buildPlanPrompt2(data, ideaText) {
  const fullName = data.fullName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const location = data.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const additionalInfo = data.additionalInfo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const ownInvestment = data.ownInvestment || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const email = data.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';

  return `–ó–∞–∫–∞–∑—á–∏–∫ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –µ–≥–æ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏–¥–µ–∏. –°–æ–±–ª—é–¥–∞–π —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞:


# 1. –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ. (–û–±—ä—ë–º ‚Äî 300-400 —Å–ª–æ–≤)
# 2. –û–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 3. –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–π –Ω–∏—à–∏ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 4. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 5. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞/—É—Å–ª—É–≥–∏ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 6. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–ª–∞–Ω (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
## –≠—Ç–∞–ø 1. 
## –≠—Ç–∞–ø 2. 
## –≠—Ç–∞–ø 3 –∏ —Ç–¥. (—Ä–∞–∑–±–µ–π –Ω–∞ –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
# 7. –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω. (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 8. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω (–û–±—ä—ë–º ‚Äî 800-1000 —Å–ª–æ–≤)
## 8.1. –ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ 
### 8.1.1. –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
### 8.1.2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤:
## 8.2. –í–∏–¥—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
### 8.2.1. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
### 8.2.2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
## 8.3. –§–æ—Ä–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è
## 8.4. –û–∂–∏–¥–∞–µ–º—ã–µ –¥–æ—Ö–æ–¥—ã
## 8.5. –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å
# 9. –ê–Ω–∞–ª–∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ (–û–±—ä—ë–º ‚Äî 300-400 —Å–ª–æ–≤)
# 10. –°–æ—Ü–∏–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (400‚Äì500 —Å–ª–æ–≤)

–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞.

----- 

üì• –î–∞–Ω–Ω—ã–µ –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞:
- –ò–º—è: ${fullName}
- –ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω: ${location}
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞: ${ownInvestment} —Ä—É–±.  
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${additionalInfo}
- Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${email}

----- 
–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏:

${ideaText.trim()}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:
- –ü–∏—à–∏ –≤ Markdown:
  - \\# –ó–∞–≥–æ–ª–æ–≤–æ–∫\\ ‚Äî —Ä–∞–∑–¥–µ–ª
  - \\## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫\\ ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é
  - \\ - –ø—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞\\ ‚Äî —Å–ø–∏—Å–∫–∏
  - \\ –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç **\\ ‚Äî –∞–∫—Ü–µ–Ω—Ç—ã
- –ë–µ–∑ "—Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞" –∏ "—Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è" ‚Äî –æ–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.
- –°—Ç—Ä–æ–≥–∏–π –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å. –ë–µ–∑ –º–µ—Ç–∞—Ñ–æ—Ä, —à—É—Ç–æ–∫, –∏ "–≤–æ–¥—ã".
- –í—Å–µ —Å—É–º–º—ã ‚Äî –≤ **—Ä—É–±–ª—è—Ö.
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã.
- –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–º–æ–Ω—Ç, –ø–æ–∫—É–ø–∫—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –¥–æ—Ö–æ–¥—ã –∏ –Ω–∞–ª–æ–≥–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π. –ü–æ—ç—Ç–∞–ø–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –ø—Ä–∏–ª–æ–∂–∏ –∫ —Ä–∞–∑–¥–µ–ª—É ¬´–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω¬ª.
- –û–±—ä—ë–º: –æ—Ç 5000 –¥–æ 6000 —Å–ª–æ–≤.
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.
- –§–æ—Ä–º–∞—Ç –ø—Ä–∏–≥–æ–¥–µ–Ω –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Word —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏.
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (‚Äú—è‚Äù, ‚Äú–º–æ–π –±–∏–∑–Ω–µ—Å‚Äù)
-----`;
}

function buildPlanPrompt(data, ideaText) {
  const fullName = data.fullName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const location = data.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const additionalInfo = data.additionalInfo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const ownInvestment = data.ownInvestment || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const email = data.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';

  return `–ó–∞–∫–∞–∑—á–∏–∫ —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –µ–≥–æ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏–¥–µ–∏. –°–æ–±–ª—é–¥–∞–π —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞:


# 1. –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ. (–û–±—ä—ë–º ‚Äî 300-400 —Å–ª–æ–≤)
# 2. –û–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 3. –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–π –Ω–∏—à–∏ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 4. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 5. –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞/—É—Å–ª—É–≥–∏ (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 6. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–ª–∞–Ω (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
## –≠—Ç–∞–ø 1. 
## –≠—Ç–∞–ø 2. 
## –≠—Ç–∞–ø 3 –∏ —Ç–¥. (—Ä–∞–∑–±–µ–π –Ω–∞ –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤ –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
# 7. –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–ª–∞–Ω. (–û–±—ä—ë–º ‚Äî 400-500 —Å–ª–æ–≤)
# 8. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω (–û–±—ä—ë–º ‚Äî 800-1000 —Å–ª–æ–≤)
## 8.1. –ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ 
### 8.1.1. –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
### 8.1.2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤:
## 8.2. –í–∏–¥—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
### 8.2.1. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
### 8.2.2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
## 8.3. –§–æ—Ä–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è
## 8.4. –û–∂–∏–¥–∞–µ–º—ã–µ –¥–æ—Ö–æ–¥—ã
## 8.5. –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å
# 9. –ê–Ω–∞–ª–∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ (–û–±—ä—ë–º ‚Äî 300-400 —Å–ª–æ–≤)
# 10. –°–æ—Ü–∏–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (400‚Äì500 —Å–ª–æ–≤)

–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞.

----- 

üì• –î–∞–Ω–Ω—ã–µ –æ—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞:
- –ò–º—è: ${fullName}
- –ì–æ—Ä–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω: ${location}
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞: ${ownInvestment} —Ä—É–±.  
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${additionalInfo}
- Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${email}
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –æ—Ç –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ (–¥–æ 350 000 —Ä—É–±–ª–µ–π)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≥–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–∏: **–¥–æ 350 000 ‚ÇΩ**

----- 
–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏:

${ideaText.trim()}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:
- –ü–∏—à–∏ –≤ Markdown:
  - \\# –ó–∞–≥–æ–ª–æ–≤–æ–∫\\ ‚Äî —Ä–∞–∑–¥–µ–ª
  - \\## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫\\ ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é
  - \\ - –ø—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞\\ ‚Äî —Å–ø–∏—Å–∫–∏
  - \\ –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç **\\ ‚Äî –∞–∫—Ü–µ–Ω—Ç—ã
- –ë–µ–∑ "—Ç–∏—Ç—É–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞" –∏ "—Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è" ‚Äî –æ–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.
- –°—Ç—Ä–æ–≥–∏–π –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å. –ë–µ–∑ –º–µ—Ç–∞—Ñ–æ—Ä, —à—É—Ç–æ–∫, –∏ "–≤–æ–¥—ã".
- –í—Å–µ —Å—É–º–º—ã ‚Äî –≤ **—Ä—É–±–ª—è—Ö.
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã.
- –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–º–æ–Ω—Ç, –ø–æ–∫—É–ø–∫—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –¥–æ—Ö–æ–¥—ã –∏ –Ω–∞–ª–æ–≥–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π. –ü–æ—ç—Ç–∞–ø–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –ø—Ä–∏–ª–æ–∂–∏ –∫ —Ä–∞–∑–¥–µ–ª—É ¬´–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω¬ª.
- –û–±—ä—ë–º: –æ—Ç 5000 –¥–æ 6000 —Å–ª–æ–≤.
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.
- –§–æ—Ä–º–∞—Ç –ø—Ä–∏–≥–æ–¥–µ–Ω –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Word —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏.
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (‚Äú—è‚Äù, ‚Äú–º–æ–π –±–∏–∑–Ω–µ—Å‚Äù)
- –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º –±–∏–∑–Ω–µ—Å–∞ –õ–ü–•, –°–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç—å (—Å—Ç–∞–≤–∫–∞ –Ω–∞–ª–æ–≥–∞ 6%), –ò–ü –£–°–ù ¬´–î–æ—Ö–æ–¥—ã¬ª (—Å—Ç–∞–≤–∫–∞ –Ω–∞–ª–æ–≥–∞ 6%), –ò–ü –£–°–ù ¬´–î–æ—Ö–æ–¥—ã –º–∏–Ω—É—Å —Ä–∞—Å—Ö–æ–¥—ã¬ª (—Å—Ç–∞–≤–∫–∞ –Ω–∞–ª–æ–≥–∞ 15%). –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º –±–∏–∑–Ω–µ—Å–∞ (–ê–û, –ù–ö–û –û–û–û –∏ –¥—Ä—É–≥–∏—Ö) –Ω–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ (–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏ –Ω–∏–∑–∫–æ–π —Å—Ç–∞–≤–∫–æ–π –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è). 
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å **–¥–≤–µ —á–∞—Å—Ç–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞**:
  1. –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ —Å–æ—Ü–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É ‚Äî –¥–æ **350 000 ‚ÇΩ**
  2. –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫–∞–∑—á–∏–∫–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
- –û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 350 000 ‚ÇΩ, **–Ω–æ —Å—É–º–º–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–∞—è —É –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ —ç—Ç–æ–≥–æ –ª–∏–º–∏—Ç–∞**.
- –£–∫–∞–∂–∏, **–∫–∞–∫–∏–µ —Ç—Ä–∞—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç—Å—è –≥–æ—Å–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π**, –∞ –∫–∞–∫–∏–µ ‚Äî –∑–∞ —Å—á—ë—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤. 
-----`;
}
function extractPreviewBlocks(markdown) {
  const lines = markdown.split("\n");
  const blocks = [];
  let currentBlock = null;

  for (let line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;

    const heading = /^#\s+(.+)/.exec(trimmed);
    if (heading) {
      if (currentBlock) blocks.push(currentBlock);
      currentBlock = { title: heading[1], content: "" };
    } else if (currentBlock) {
      currentBlock.content += trimmed + "\n";
    }
  }

  if (currentBlock) blocks.push(currentBlock);

  return blocks.slice(0, 2);
}

function preprocessText(text) {
  return text.split('\n')
    .map(line => {
      const trimmed = line.trim();
      if (!trimmed) return '';
      if (/^\d+\.\s+/.test(trimmed) && !/\*\*/.test(trimmed)) {
        return `### ${trimmed}`;
      }
      return trimmed;
    })
    .join('\n')
    .replace(/\(\d{2,4}‚Äì\d{2,4} —Å–ª–æ–≤\)/g, '');
}

function buildPaymentParams({ amount, returnUrl, email, orderId }) {
  return {
    amount: { value: amount, currency: 'RUB' },
    confirmation: {
      type: 'redirect',
      return_url: returnUrl,
    },
    capture: true,
    description: `–û–ø–ª–∞—Ç–∞ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞ –¥–ª—è ${email}`,
    metadata: { orderId },
    receipt: {
      customer: { email },
      items: [{
        description: '–ë–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω',
        quantity: 1,
        amount: { value: amount, currency: 'RUB' },
        vat_code: 1,
        payment_mode: 'full_payment',
        payment_subject: 'service'
      }]
    }
  };
}

async function safeGptCall({ messages, max_tokens = 8192, temperature = 0.7 }) {
  let retries = 5;

  for (let i = 0; i < retries; i++) {
    try {
      return await openai.chat.completions.create({
        model: 'gpt-4o',
        messages,
        temperature,
        max_tokens
      });
    } catch (err) {
      if (err.code === 'rate_limit_exceeded') {
        const retryAfter = err.headers?.['retry-after'] || 30;
        const waitTime = Number(retryAfter) * 1000;
        console.warn(`üö¶ Rate limit. –ñ–¥—ë–º ${waitTime / 1000} —Å–µ–∫...`);
        await delay(waitTime);
      } else {
        throw err; // –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –ª–∏–º–∏—Ç–æ–º ‚Äî –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º
      }
    }
  }

  throw new Error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫ GPT (rate limit)');
}


function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


module.exports = { ADMIN_EMAILS, buildIdeasPrompt, buildPlanPrompt, safeGptCall, preprocessText, buildPaymentParams, buildPlanPrompt2, buildIdeasPrompt2 };