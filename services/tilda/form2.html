<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rec = document.querySelector('#rec1029493506');
    if (!rec) return;

    const form = rec.querySelector('form');
    const button = rec.querySelector('button.t-submit');
    if (!form || !button) return;

    button.addEventListener('click', function () {
      setTimeout(() => {
        const email = form.querySelector('input[name="email"]');
        const location = form.querySelector('input[name="location"]');

        if (!email || !location) {
          console.warn('❌ Нет нужных полей');
          return;
        }

        const emailValue = email.value.trim();
        const locationValue = location.value.trim();

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailValue || !emailPattern.test(emailValue)) {
          email.reportValidity();
          console.warn('❌ Email не прошёл валидацию');
          return;
        }

        if (!locationValue) {
          location.reportValidity();
          console.warn('❌ Не указано местоположение');
          return;
        }

        const payload = {
          email: emailValue,
          fullName: form.querySelector('input[name="fullName"]')?.value.trim() || '',
          location: locationValue,
          additionalInfo: form.querySelector('textarea[name="additionalInfo"]')?.value.trim() || '',
          ownInvestments: form.querySelector('input[name="ownInvestment"]')?.value || '0',
          formname: 'form2',
          source_url: window.location.href
        };

        fetch('https://gpt-plan-api-production.up.railway.app/tilda-submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(payload).toString()
        }).then(res => res.json()).then(result => {
          if (result?.confirmation_url) {
            console.log('✅ Переход к оплате...');
            window.location.href = result.confirmation_url;
          } else {
            console.error('❌ Ошибка генерации:', result);
            alert('Ошибка генерации. Попробуйте позже.');
          }
        }).catch(err => {
          console.error('❌ Ошибка отправки:', err);
          alert('Ошибка соединения. Попробуйте позже.');
        });
      }, 50);
    });
  });
</script>
