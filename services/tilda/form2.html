<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rec = document.querySelector('#rec1029493506'); // ID –±–ª–æ–∫–∞ Tilda
    if (!rec) return;

    const form = rec.querySelector('form');
    const button = rec.querySelector('button.t-submit');
    if (!form || !button) return;

    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è Tilda
    form.setAttribute('data-formactiontype', '0');
    form.removeAttribute('action');
    form.removeAttribute('target');

    button.addEventListener('click', async function (e) {
      e.preventDefault();
      e.stopImmediatePropagation(); // üîí –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –í–°–ï –¥—Ä—É–≥–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ Tilda

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤—Ä—É—á–Ω—É—é
      const email = form.querySelector('input[name="email"]');
      const location = form.querySelector('input[name="location"]');

      if (!email || !location || email.value.trim() === '' || location.value.trim() === '') {
        if (email.value.trim() === '') email.reportValidity();
        else location.reportValidity();
        return;
      }

      // 2. –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

      // 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      const payload = {
        email: email.value.trim(),
        fullName: form.querySelector('input[name="fullName"]')?.value.trim() || '',
        location: location.value.trim(),
        wishes: form.querySelector('textarea[name="additionalInfo"]')?.value.trim() || '',
        ownInvestments: form.querySelector('input[name="ownInvestment"]')?.value || '0',
        formname: 'form2'
      };

      // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend
      try {
        const res = await fetch('https://gpt-plan-api-production.up.railway.app/tilda-submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(payload).toString()
        });

        const result = await res.json();

        if (!res.ok || !result.confirmation_url) {
          throw new Error(result?.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        }

        window.location.href = result.confirmation_url;

      } catch (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  });
</script>
