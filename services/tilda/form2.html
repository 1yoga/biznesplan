<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rec = document.querySelector('#rec1029493506'); // ID блока Tilda
    if (!rec) return;

    const form = rec.querySelector('form');
    const button = rec.querySelector('button.t-submit');
    if (!form || !button) return;

    // Отключаем встроенные действия Tilda
    form.setAttribute('data-formactiontype', '0');
    form.removeAttribute('action');
    form.removeAttribute('target');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();             // ⛔ отключаем отправку
      e.stopImmediatePropagation();  // ⛔ отключаем Tilda Webhook/Email

      // ✅ Браузер сам показывает ошибки, если checkValidity не прошла — сюда не дойдёт

      console.log('✅ Валидация пройдена, отправляем данные...');

      // 1. Собираем данные
      const email = form.querySelector('input[name="email"]')?.value.trim();
      const fullName = form.querySelector('input[name="fullName"]')?.value.trim() || '';
      const location = form.querySelector('input[name="location"]')?.value.trim();
      const wishes = form.querySelector('textarea[name="additionalInfo"]')?.value.trim() || '';
      const ownInvestments = form.querySelector('input[name="ownInvestment"]')?.value || '0';

      // 2. UI ожидание
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = '⏳ Генерация...';

      // 3. Запрос
      try {
        const response = await fetch('https://gpt-plan-api-production.up.railway.app/tilda-submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            email,
            fullName,
            location,
            wishes,
            ownInvestments,
            formname: 'form2'
          }).toString()
        });

        const result = await response.json();

        if (!response.ok || !result.confirmation_url) {
          throw new Error(result?.error || 'Ошибка генерации');
        }

        window.location.href = result.confirmation_url;

      } catch (err) {
        console.error('❌ Ошибка при отправке:', err);
        alert('Произошла ошибка. Попробуйте позже.');
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  });
</script>
